<div xmlns:th="http://www.thymeleaf.org" th:fragment="content">
  <div class="container my-4">
    <!-- üßæ Ti√™u ƒë·ªÅ -->
    <h2 class="mb-4">
      <i class="bi bi-cart-check me-2 text-primary"></i>Gi·ªè h√†ng c·ªßa b·∫°n
    </h2>

    <!-- üîπ Gi·ªè h√†ng tr·ªëng -->
    <div th:if="${#lists.isEmpty(items)}" class="alert alert-info d-flex align-items-center">
      <i class="bi bi-info-circle-fill me-2"></i>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.
    </div>

    <!-- ‚úÖ Danh s√°ch s·∫£n ph·∫©m -->
    <div th:if="${!#lists.isEmpty(items)}">
      <div class="table-responsive">
        <table class="table table-bordered align-middle text-center">
          <thead class="table-light">
          <tr>
            <th>#</th>
            <th>S·∫£n ph·∫©m</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>ƒê∆°n gi√°</th>
            <th>Th√†nh ti·ªÅn</th>
            <th>Xo√°</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="item, iter : ${items}">
            <td th:text="${iter.count}">1</td>
            <td th:text="${item.product.name}">T√™n SP</td>
            <td>
              <form th:action="@{/user/cart/update}" method="post" class="d-flex justify-content-center">
                <input type="hidden" name="cartItemId" th:value="${item.cartItemId}" />
                <input type="number" name="quantity" min="1" class="form-control w-50"
                       th:value="${item.quantity}" required />
                <button type="submit" class="btn btn-sm btn-outline-success ms-2">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </form>
            </td>
            <td th:text="${#numbers.formatDecimal(item.product.price, 0, 'POINT', 3, 'COMMA') + ' ƒë'}">0</td>
            <td th:text="${#numbers.formatDecimal(item.product.price * item.quantity, 0, 'POINT', 3, 'COMMA') + ' ƒë'}">0</td>
            <td>
              <form th:action="@{/user/cart/remove}" method="post">
                <input type="hidden" name="cartItemId" th:value="${item.cartItemId}" />
                <button type="submit" class="btn btn-sm btn-danger" title="Xo√° s·∫£n ph·∫©m">
                  <i class="bi bi-trash-fill"></i>
                </button>
              </form>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- üí∞ T·ªïng ti·ªÅn -->
      <div class="text-end mt-4">
        <h5 class="text-primary mb-3">
          <i class="bi bi-cash-coin me-1"></i>T·ªïng ti·ªÅn:
          <span class="fw-bold" th:text="${#numbers.formatDecimal(total, 0, 'POINT', 3, 'COMMA') + ' ƒë'}">0 ƒë</span>
        </h5>
      </div>

      <!-- üí∞ Form thanh to√°n -->
      <form th:action="@{/user/checkout}" method="post" id="checkoutForm"
            class="mt-4 border p-3 rounded shadow-sm bg-light">
        <div class="mb-3">
          <label for="addressDetail" class="form-label">ƒê·ªãa ch·ªâ giao h√†ng:</label>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="province">T·ªânh/Th√†nh ph·ªë</label>
              <select id="province" class="form-select" required></select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="district">Qu·∫≠n/Huy·ªán</label>
              <select id="district" class="form-select" required></select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="ward">Ph∆∞·ªùng/X√£</label>
              <select id="ward" name="ward" class="form-select" required></select>
            </div>
          </div>
          <div class="mb-3">
            <label for="addressDetail">ƒê·ªãa ch·ªâ c·ª• th·ªÉ (s·ªë nh√†, ƒë∆∞·ªùng...)</label>
            <input type="text" id="addressDetail" class="form-control" placeholder="123 L√™ L·ª£i..." required />
          </div>
          <!-- ·∫®n input g·ªôp ƒë·ªãa ch·ªâ -->
          <input type="hidden" id="shippingAddress" name="shippingAddress" />
        </div>

        <div class="mb-3">
          <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n:</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" value="COD" id="cod" checked>
            <label class="form-check-label" for="cod">Thanh to√°n khi nh·∫≠n h√†ng (COD)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" value="VNPAY" id="vnpay">
            <label class="form-check-label" for="vnpay">Thanh to√°n VNPay</label>
          </div>
        </div>

        <div class="text-end">
          <button type="submit" class="btn btn-success btn-lg">
            <i class="bi bi-credit-card-2-front me-1"></i>Ti·∫øn h√†nh thanh to√°n
          </button>
        </div>
      </form>
    </div>

  </div>
  <!-- ‚úÖ JavaScript load ƒë·ªãa ch·ªâ v√† g·ªôp tr∆∞·ªõc khi submit -->
  <script>
  const provinceSelect = document.getElementById("province");
  const districtSelect = document.getElementById("district");
  const wardSelect = document.getElementById("ward");
  const addressDetailInput = document.getElementById("addressDetail");
  const shippingAddressInput = document.getElementById("shippingAddress");

  // Load t·ªânh
  fetch("https://provinces.open-api.vn/api/?depth=1")
    .then(res => res.json())
    .then(data => {
      provinceSelect.innerHTML = "<option value=''>-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>";
      data.forEach(province => {
        const opt = document.createElement("option");
        opt.value = province.code;
        opt.textContent = province.name;
        provinceSelect.appendChild(opt);
      });
    });

  // Load qu·∫≠n/huy·ªán khi ch·ªçn t·ªânh
  provinceSelect.addEventListener("change", () => {
    const provinceCode = provinceSelect.value;
    districtSelect.innerHTML = "<option value=''>-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>";
    wardSelect.innerHTML = "<option value=''>-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>";

    fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`)
      .then(res => res.json())
      .then(data => {
        data.districts.forEach(district => {
          const opt = document.createElement("option");
          opt.value = district.code;
          opt.textContent = district.name;
          districtSelect.appendChild(opt);
        });
      });
  });

  // Load x√£ khi ch·ªçn huy·ªán
  districtSelect.addEventListener("change", () => {
    const districtCode = districtSelect.value;
    wardSelect.innerHTML = "<option value=''>-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>";

    fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`)
      .then(res => res.json())
      .then(data => {
        data.wards.forEach(ward => {
          const opt = document.createElement("option");
          opt.value = ward.name;
          opt.textContent = ward.name;
          wardSelect.appendChild(opt);
        });
      });
  });

  // G·ªôp ƒë·ªãa ch·ªâ g·ª≠i l√™n server
  document.getElementById("checkoutForm").addEventListener("submit", function (e) {
    if (!provinceSelect.value || !districtSelect.value || !wardSelect.value || !addressDetailInput.value.trim()) {
      alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªãa ch·ªâ giao h√†ng.");
      e.preventDefault();
      return;
    }

    const provinceText = provinceSelect.options[provinceSelect.selectedIndex].text;
    const districtText = districtSelect.options[districtSelect.selectedIndex].text;
    const wardText = wardSelect.options[wardSelect.selectedIndex].text;
    const detail = addressDetailInput.value;

    const fullAddress = `${detail}, ${wardText}, ${districtText}, ${provinceText}`;
    shippingAddressInput.value = fullAddress;
  });
</script>
</div>


