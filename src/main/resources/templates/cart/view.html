<div xmlns:th="http://www.thymeleaf.org" th:fragment="content">
  <div class="container my-4">
    <!-- üõí Ti√™u ƒë·ªÅ -->
    <h2 class="mb-4 text-primary">
      <i class="bi bi-cart-check me-2"></i> Gi·ªè h√†ng c·ªßa b·∫°n
    </h2>

    <div th:if="${param.paid}" class="alert alert-success d-flex align-items-center">
      <i class="bi bi-check-circle-fill me-2"></i> Thanh to√°n th√†nh c√¥ng! ƒê∆°n h√†ng c·ªßa b·∫°n ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω.
    </div>
    <div th:if="${param.fail}" class="alert alert-danger d-flex align-items-center">
      <i class="bi bi-x-circle-fill me-2"></i> Thanh to√°n th·∫•t b·∫°i! Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ch·ªçn ph∆∞∆°ng th·ª©c kh√°c.
    </div>

    <!-- üß∫ Gi·ªè h√†ng tr·ªëng -->
    <div th:if="${#lists.isEmpty(items)}" class="alert alert-info d-flex align-items-center">
      <i class="bi bi-info-circle-fill me-2"></i> Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.
    </div>

    <!-- üì¶ Danh s√°ch s·∫£n ph·∫©m trong gi·ªè -->
    <div th:if="${!#lists.isEmpty(items)}">
      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
          <thead class="table-light">
          <tr>
            <th>#</th>
            <th>S·∫£n ph·∫©m</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>ƒê∆°n gi√°</th>
            <th>Th√†nh ti·ªÅn</th>
            <th>Xo√°</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="item, iter : ${items}">
            <td th:text="${iter.count}">1</td>
            <td class="fw-semibold text-start ps-3" th:text="${item.product.name}">T√™n SP</td>
            <td>
              <form th:action="@{/user/cart/update}" method="post" class="d-flex justify-content-center align-items-center">
                <input type="hidden" name="cartItemId" th:value="${item.cartItemId}" />

                <div class="input-group" style="max-width: 120px;">
                  <button class="btn btn-outline-secondary btn-sm" type="button" onclick="changeQuantity(this, -1)">-</button>
                  <input type="number"
                         name="quantity"
                         min="1"
                         th:attr="max=${item.product.stock}"
                         required
                         class="form-control text-center"
                         th:value="${item.quantity}" />

                  <button class="btn btn-outline-secondary btn-sm" type="button" onclick="changeQuantity(this, 1)">+</button>
                </div>
              </form>
            </td>
            <td th:text="${#numbers.formatDecimal(item.product.price, 0, 'COMMA', 3, 'POINT') + ' ƒë'}"></td>
            <td th:text="${#numbers.formatDecimal(item.product.price * item.quantity, 0, 'COMMA', 3, 'POINT') + ' ƒë'}"></td>

            <td>
              <form th:action="@{/user/cart/remove}" method="post">
                <input type="hidden" name="cartItemId" th:value="${item.cartItemId}" />
                <button class="btn btn-sm btn-danger" title="Xo√° s·∫£n ph·∫©m" type="submit">
                  <i class="bi bi-trash-fill"></i>
                </button>
              </form>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
      <!-- üéü M√£ khuy·∫øn m√£i -->
      <div class="mt-4">
        <h5><i class="bi bi-ticket-perforated me-2 text-warning"></i> M√£ khuy·∫øn m√£i</h5>
        <select name="couponId" id="couponId" class="form-select">
          <option value="">-- Ch·ªçn m√£ khuy·∫øn m√£i --</option>
          <option th:each="uc : ${coupons}"
                  th:value="${uc.userCouponId}"
                  th:data-discount="${uc.coupon.discountPercent}"
                  th:text="${uc.coupon.code + ' - Gi·∫£m ' + uc.coupon.discountPercent + '%'}">
          </option>
        </select>
      </div>

      <!-- üíµ T·ªïng ti·ªÅn -->
      <div class="text-end mt-4">
        <h5 class="text-primary fw-bold">
          <i class="bi bi-cash-coin me-1"></i> T·ªïng ti·ªÅn:
          <span id="totalPrice"
                th:attr="data-total=${total}"
                th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 3, 'COMMA') + ' ƒë'}">
          </span>
        </h5>
      </div>

      <!-- üßæ Form thanh to√°n -->
      <form th:action="@{/user/checkout}" method="post" id="checkoutForm"
            class="mt-4 border p-4 rounded-4 shadow-sm bg-light">
        <h4 class="mb-3"><i class="bi bi-truck me-2 text-success"></i>Th√¥ng tin giao h√†ng</h4>

        <div class="row g-3">
          <div class="col-md-4">
            <label for="province" class="form-label">T·ªânh/Th√†nh ph·ªë</label>
            <select id="province" class="form-select" required></select>
          </div>
          <div class="col-md-4">
            <label for="district" class="form-label">Qu·∫≠n/Huy·ªán</label>
            <select id="district" class="form-select" required></select>
          </div>
          <div class="col-md-4">
            <label for="ward" class="form-label">Ph∆∞·ªùng/X√£</label>
            <select id="ward" name="ward" class="form-select" required></select>
          </div>
        </div>

        <div class="mt-3">
          <label for="addressDetail" class="form-label">ƒê·ªãa ch·ªâ c·ª• th·ªÉ (s·ªë nh√†, ƒë∆∞·ªùng...)</label>
          <input type="text" id="addressDetail" class="form-control" placeholder="123 L√™ L·ª£i..." required />
          <input type="hidden" id="shippingAddress" name="shippingAddress" />
        </div>

        <div class="mt-4">
          <h5><i class="bi bi-credit-card me-2 text-secondary"></i>Ph∆∞∆°ng th·ª©c thanh to√°n</h5>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" value="COD" id="cod" checked>
            <label class="form-check-label" for="cod">Thanh to√°n khi nh·∫≠n h√†ng (COD)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" value="VNPAY" id="vnpay">
            <label class="form-check-label" for="vnpay">Thanh to√°n VNPAY</label>
          </div>
        </div>
        <input type="hidden" id="finalTotal" name="finalTotal" th:value="${total}" />
        <div class="text-end mt-4">
          <button type="submit" class="btn btn-success btn-lg px-4">
            <i class="bi bi-credit-card-2-front me-2"></i>Thanh to√°n
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ‚úÖ Script: Load ƒë·ªãa ch·ªâ + G·ªôp ƒë·ªãa ch·ªâ -->
  <script>
    const provinceSelect = document.getElementById("province");
    const districtSelect = document.getElementById("district");
    const wardSelect = document.getElementById("ward");
    const addressDetailInput = document.getElementById("addressDetail");
    const shippingAddressInput = document.getElementById("shippingAddress");

    // Load t·ªânh
    fetch("https://provinces.open-api.vn/api/?depth=1")
      .then(res => res.json())
      .then(data => {
        provinceSelect.innerHTML = "<option value=''>-- Ch·ªçn T·ªânh/Th√†nh ph·ªë --</option>";
        data.forEach(province => {
          const opt = document.createElement("option");
          opt.value = province.code;
          opt.textContent = province.name;
          provinceSelect.appendChild(opt);
        });
      });

    // Load qu·∫≠n
    provinceSelect.addEventListener("change", () => {
      const provinceCode = provinceSelect.value;
      districtSelect.innerHTML = "<option value=''>-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>";
      wardSelect.innerHTML = "<option value=''>-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>";

      fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`)
        .then(res => res.json())
        .then(data => {
          data.districts.forEach(district => {
            const opt = document.createElement("option");
            opt.value = district.code;
            opt.textContent = district.name;
            districtSelect.appendChild(opt);
          });
        });
    });

    // Load x√£
    districtSelect.addEventListener("change", () => {
      const districtCode = districtSelect.value;
      wardSelect.innerHTML = "<option value=''>-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>";

      fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`)
        .then(res => res.json())
        .then(data => {
          data.wards.forEach(ward => {
            const opt = document.createElement("option");
            opt.value = ward.name;
            opt.textContent = ward.name;
            wardSelect.appendChild(opt);
          });
        });
    });

    // G·ªôp ƒë·ªãa ch·ªâ
    document.getElementById("checkoutForm").addEventListener("submit", function (e) {
      if (!provinceSelect.value || !districtSelect.value || !wardSelect.value || !addressDetailInput.value.trim()) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªãa ch·ªâ giao h√†ng.");
        e.preventDefault();
        return;
      }

      const provinceText = provinceSelect.options[provinceSelect.selectedIndex].text;
      const districtText = districtSelect.options[districtSelect.selectedIndex].text;
      const wardText = wardSelect.options[wardSelect.selectedIndex].text;
      const detail = addressDetailInput.value.trim();

      shippingAddressInput.value = `${detail}, ${wardText}, ${districtText}, ${provinceText}`;
    });

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("input[name='quantity']").forEach(input => {
    const max = parseInt(input.getAttribute("max"));

    // Khi ng∆∞·ªùi d√πng nh·∫≠p tr·ª±c ti·∫øp
    input.addEventListener("input", function () {
      let value = parseInt(this.value);

      if (!value || value < 1) {
        this.value = 1;
      } else if (max && value > max) {
        this.value = max;
        alert("B·∫°n ƒë√£ ƒë·∫°t s·ªë l∆∞·ª£ng t·ªìn kho t·ªëi ƒëa cho s·∫£n ph·∫©m n√†y!");
      }

      // Submit sau khi nh·∫≠p
      const form = this.closest("form");
      setTimeout(() => form.submit(), 500);
    });
  });
});

function changeQuantity(button, delta) {
  const input = button.parentElement.querySelector("input[name='quantity']");
  const max = parseInt(input.getAttribute("max")); // ƒë√¢y ch√≠nh l√† stock trong DB
  let current = parseInt(input.value) || 1;

  current += delta;
  if (current < 1) current = 1;
  if (max && current > max) {
    current = max;
    alert("B·∫°n ƒë√£ ƒë·∫°t s·ªë l∆∞·ª£ng t·ªìn kho t·ªëi ƒëa cho s·∫£n ph·∫©m n√†y!");
  }

  input.value = current;

  // Submit form sau 300ms
  setTimeout(() => {
    const form = button.closest("form");
    form.submit();
  }, 300);
}


document.addEventListener("DOMContentLoaded", function () {
      // üéü Gi·∫£m gi√°
      const couponSelect = document.getElementById("couponId");
      const totalPriceEl = document.getElementById("totalPrice");
      const finalTotalInput = document.getElementById("finalTotal");

      const originalTotal = parseFloat(totalPriceEl.dataset.total);

      couponSelect.addEventListener("change", function () {
        const selectedOption = couponSelect.options[couponSelect.selectedIndex];
        const discountPercent = selectedOption.getAttribute("data-discount");

        let finalTotal = originalTotal;
        if (discountPercent) {
          finalTotal = originalTotal * (1 - discountPercent / 100);
        }

        // C·∫≠p nh·∫≠t giao di·ªán + hidden input
        totalPriceEl.textContent = finalTotal.toLocaleString("vi-VN") + " ƒë";
        finalTotalInput.value = finalTotal.toFixed(0);
      });
    });
  </script>
  </script>
</div>
