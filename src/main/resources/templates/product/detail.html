<!-- templates/product/detail.html -->
<div xmlns:th="http://www.thymeleaf.org" th:fragment="content" class="container py-4">

  <!-- ▸ Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb bg-light p-2 rounded shadow-sm">
      <li class="breadcrumb-item">
        <a th:href="@{/}">
          <i class="bi bi-house-door-fill"></i> Trang chủ
        </a>
      </li>
      <li class="breadcrumb-item active" aria-current="page"
          th:text="${product.name}">Chi tiết</li>
    </ol>
  </nav>

  <div class="row g-4">
    <!-- ▸ Hình ảnh -->
    <div class="col-md-5">
      <div class="border rounded-3 p-3 shadow-sm bg-white">
        <img th:if="${product.images != null}"
             th:src="@{/images/{img}(img=${product.images})}"
             class="img-fluid rounded w-100" alt="Ảnh sản phẩm">
        <img th:unless="${product.images != null}"
             src="/images/no-image.png"
             class="img-fluid rounded w-100" alt="No image">
      </div>
    </div>

    <!-- ▸ Thông tin sản phẩm -->
    <div class="col-md-7">
      <h2 class="fw-bold text-primary mb-3" th:text="${product.name}">Tên sản phẩm</h2>

      <!-- ▸ Giá & khuyến mãi -->
      <div class="mb-3"
           th:with="hasPromo=${product.productPromotions != null and !#lists.isEmpty(product.productPromotions)},
                    discount=${hasPromo} ? ${product.productPromotions[0].promotion.discountPercent} : 0,
                    promoPrice=${hasPromo} ? ${product.price * (1 - discount / 100)} : ${product.price}">
        <div th:if="${hasPromo}">
          <span class="fs-4 fw-bold text-danger"
                th:text="${#numbers.formatDecimal(promoPrice, 0, 'POINT', 3, 'COMMA')} + ' đ'"></span>
          <span class="text-muted text-decoration-line-through ms-2"
                th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 3, 'COMMA')} + ' đ'"></span>
          <span class="badge bg-warning text-dark ms-2">
            <i class="bi bi-tags-fill"></i> Giảm <span th:text="${discount}"></span>%
          </span>
        </div>
        <div th:unless="${hasPromo}">
          <span class="fs-5 fw-semibold"
                th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 3, 'COMMA')} + ' đ'"></span>
        </div>
      </div>

      <p class="mb-1"><strong>Nhà cung cấp:</strong>
        <span th:text="${product.supplier != null ? product.supplier.name : 'Đang cập nhật'}"></span>
      </p>
      <p class="mb-3"><strong>Kho:</strong>
        <span class="badge bg-info text-dark" th:text="${product.stock} + ' sản phẩm'"></span>
      </p>

      <!-- ▸ Đánh giá trung bình -->
      <div class="mb-3 d-flex align-items-center gap-2 detail-rating"
           th:with="avg=${#aggregates.avg(reviews.![rating]) ?: 0}">
        <strong><i class="bi bi-star-fill text-warning"></i> Đánh giá:</strong>
        <span class="detail-rating-stars">
    <i class="bi bi-star-fill detail-star"
       th:each="i : ${#numbers.sequence(1,5)}"
       th:classappend="${i <= avg} ? 'text-warning' : 'text-secondary'"></i>
  </span>
        <span class="ms-2 text-muted detail-rating-count"
              th:text="'(' + ${#lists.size(reviews)} + ' đánh giá)'"></span>
      </div>
      <div class="d-flex align-items-center gap-3 mt-4 detail-action-buttons">
        <!-- Thêm vào giỏ -->
        <form th:action="@{/user/cart/add}" method="post" class="d-flex align-items-center m-0">
          <input type="hidden" name="productId" th:value="${product.productId}">
          <input type="number" name="quantity" value="1" min="1"
                 class="form-control me-2" style="width:100px;">
          <button type="submit" class="btn btn-success px-4">
            <i class="bi bi-cart-plus me-1"></i>
          </button>
        </form>

        <!-- Thêm vào yêu thích -->
        <form th:action="@{/user/favorites/add}" method="post" class="m-0">
          <input type="hidden" name="productId" th:value="${product.productId}" />
          <button type="submit" class="btn btn-outline-danger px-4">
            <i class="bi bi-heart me-1"></i>
          </button>
        </form>
      </div>
      <div id="description-mol" class="text-muted description-collapsed" th:utext="${product.compatibilitySpecs}">
        Mô tả sản phẩm…
      </div>
      <button id="toggleBtn-mol" type="button" class="btn btn-link p-0 mt-2">Xem thêm</button>


      <div class="product-description mt-4">
        <h5 class="fw-bold text-primary mb-2">
          <i class="bi bi-info-circle me-2"></i>Mô tả sản phẩm
        </h5>
        <div id="description" class="description-content collapsed" th:utext="${product.description}">
          Mô tả sản phẩm…
        </div>
        <button id="toggleBtn" type="button" class="btn btn-sm btn-link px-2 mt-2">
          <i class="bi bi-chevron-down"></i> Xem thêm
        </button>
      </div>
    </div>

    <!-- ▸ Bình luận -->
    <div class="mt-5">
      <h4 class="mb-4"><i class="bi bi-chat-dots me-2"></i>Bình luận</h4>

      <!-- Danh sách đánh giá -->
      <div class="list-group mb-4" th:if="${!#lists.isEmpty(reviews)}">
        <div class="list-group-item mb-3 shadow-sm rounded" th:each="rv : ${reviews}" th:id="${'rv-' + rv.reviewId}">
          <div class="d-flex justify-content-between mb-1">
            <strong th:text="${rv.user != null ? rv.user.name : 'Ẩn danh'}">Người dùng</strong>
            <small class="text-muted" th:text="${#temporals.format(rv.createdAt,'dd/MM/yyyy')}"></small>
          </div>
          <div class="mb-2">
            <i class="bi bi-star-fill"
               th:each="i : ${#numbers.sequence(1,5)}"
               th:classappend="${i <= rv.rating} ? 'text-warning' : 'text-secondary'"></i>
          </div>
          <p class="mb-2" th:text="${rv.comment}">Nội dung…</p>

          <!-- Nút sửa/xóa -->
          <div th:if="${userEmail != null and rv.user != null and userEmail == rv.user.email}" class="mt-2">
            <a th:href="@{'/products/detail/' + ${product.productId} + '?editingReviewId=' + ${rv.reviewId} + '#rv-' + ${rv.reviewId}}"
               class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil-square"></i> Chỉnh sửa</a>
            <form th:action="@{/products/review/delete}" method="post" class="d-inline ms-2"
                  onsubmit="return confirm('Bạn chắc chắn muốn xóa bình luận này?');">
              <input type="hidden" name="reviewId" th:value="${rv.reviewId}" />
              <input type="hidden" name="productId" th:value="${product.productId}" />
              <button type="submit" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-trash"></i> Xóa
              </button>
            </form>
          </div>

          <!-- Form chỉnh sửa -->
          <div th:if="${editingReview != null and editingReview.reviewId == rv.reviewId}" class="mt-3">
            <form th:action="@{/products/review/edit}" method="post" class="p-3 bg-light rounded">
              <input type="hidden" name="productId" th:value="${product.productId}" />
              <input type="hidden" name="reviewId" th:value="${editingReview.reviewId}" />
              <div class="mb-2">
                <label class="form-label">Số sao:</label>
                <select name="rating" class="form-select w-auto">
                  <option th:each="i : ${#numbers.sequence(1,5)}"
                          th:value="${i}" th:text="${i + ' sao'}"
                          th:selected="${i == editingReview.rating}"></option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">Bình luận:</label>
                <textarea name="comment" class="form-control" rows="3"
                          th:text="${editingReview.comment}"></textarea>
              </div>
              <button type="submit" class="btn btn-warning btn-sm">Lưu thay đổi</button>
              <a th:href="@{/products/detail/{id}(id=${product.productId})}" class="btn btn-secondary btn-sm ms-2">Hủy</a>
            </form>
          </div>
        </div>
      </div>

      <!-- Form tạo mới -->
      <form th:action="@{/products/review}" method="post"
            th:unless="${editingReview != null}"
            class="p-4 bg-light rounded shadow-sm detail-review-form">
        <input type="hidden" name="productId" th:value="${product.productId}">

        <div class="mb-3 detail-rating-select">
          <label class="form-label fw-semibold">Đánh giá (sao)</label>
          <div class="detail-star-picker">
            <i class="bi bi-star detail-star-icon" data-value="1"></i>
            <i class="bi bi-star detail-star-icon" data-value="2"></i>
            <i class="bi bi-star detail-star-icon" data-value="3"></i>
            <i class="bi bi-star detail-star-icon" data-value="4"></i>
            <i class="bi bi-star detail-star-icon" data-value="5"></i>
            <input type="hidden" name="rating" class="detail-rating-input" required>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Bình luận</label>
          <textarea name="comment" rows="3" class="form-control" required placeholder="Viết bình luận của bạn..."></textarea>
        </div>

        <button type="submit" class="btn btn-primary px-4 detail-review-submit">
          <i class="bi bi-send"></i> Gửi đánh giá
        </button>
      </form>

      <!-- ▸ Script để chọn sao -->
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const stars = document.querySelectorAll('.detail-star-picker .detail-star-icon');
          const ratingInput = document.querySelector('.detail-rating-input');

          stars.forEach(star => {
            star.addEventListener('click', () => {
              const value = star.getAttribute('data-value');
              ratingInput.value = value;

              stars.forEach(s => {
                if(s.getAttribute('data-value') <= value) {
                  s.classList.add('bi-star-fill', 'text-warning');
                  s.classList.remove('bi-star', 'text-secondary');
                } else {
                  s.classList.add('bi-star', 'text-secondary');
                  s.classList.remove('bi-star-fill', 'text-warning');
                }
              });
            });
          });
        });


  document.addEventListener("DOMContentLoaded", function () {
  const desc = document.getElementById("description");
  const btn = document.getElementById("toggleBtn");

  btn.addEventListener("click", function () {
    desc.classList.toggle("collapsed");
    desc.classList.toggle("expanded");
    btn.classList.toggle("active");

    if (desc.classList.contains("expanded")) {
      btn.innerHTML = '<i class="bi bi-chevron-up"></i> Thu gọn';
    } else {
      btn.innerHTML = '<i class="bi bi-chevron-down"></i> Xem thêm';
    }
  });
});


  document.addEventListener("DOMContentLoaded", function () {
      const desc = document.getElementById("description-mol");
      const btn = document.getElementById("toggleBtn-mol");

      btn.addEventListener("click", function () {
          desc.classList.toggle("description-collapsed-mol");
          desc.classList.toggle("description-expanded-mol");

          if (desc.classList.contains("description-expanded-mol")) {
              btn.textContent = "Thu gọn";
          } else {
              btn.textContent = "Xem thêm";
          }
      });
  });


      </script>
    </div>
  </div>
</div>