<div xmlns:th="http://www.thymeleaf.org" th:fragment="content">

    <div class="container my-4">

        <!-- Danh m·ª•c + T√¨m ki·∫øm -->
        <div class="row mb-4 align-items-start">
            <div class="col-md-4 mb-2">
                <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#categoryCollapse" aria-expanded="false" aria-controls="categoryCollapse">
                    üìÇ Ch·ªçn danh m·ª•c
                </button>
            </div>
            <div class="col-md-8 mb-2">
                <form class="d-flex" role="search" th:action="@{/products/search}" method="get">
                    <input class="form-control me-2" type="search" name="keyword" placeholder="T√¨m s·∫£n ph·∫©m..." aria-label="Search" required>
                    <button class="btn btn-outline-success" type="submit">T√¨m</button>
                </form>
            </div>

            <div class="col-12">
                <div class="collapse mt-2" id="categoryCollapse">
                    <div class="btn-group flex-wrap" role="group" aria-label="Category buttons">
                        <th:block th:each="category : ${categories}">
                            <a class="btn btn-outline-primary me-2 mb-2"
                               th:text="${category.name}"
                               th:href="@{/products/category/{id}(id=${category.categoryId})}"></a>
                        </th:block>
                    </div>
                </div>
            </div>
        </div>

        <!-- Danh m·ª•c khuy·∫øn m√£i h√¥m nay -->
        <div class="row mb-4">
            <div class="col-12">
                <h5 class="text-danger">üéØ Danh m·ª•c ƒëang khuy·∫øn m√£i h√¥m nay</h5>
                <div th:if="${#lists.isEmpty(discountedCategories)}">
                    <p class="text-muted">Hi·ªán kh√¥ng c√≥ danh m·ª•c n√†o ƒëang ƒë∆∞·ª£c khuy·∫øn m√£i.</p>
                </div>
                <div th:if="${!#lists.isEmpty(discountedCategories)}" class="d-flex flex-wrap gap-2">
                    <div th:each="dc : ${discountedCategories}" class="badge bg-warning text-dark p-2">
                        <img th:if="${dc.images != null}"
                             th:src="@{/images/{img}(img=${dc.images})}"
                             alt="Category Image" width="80" height="80"/>
                        <span th:text="${dc.categoryName}">Danh m·ª•c</span>:
                        <strong th:text="${dc.maxDiscountToday + '%'}">%</strong> -
                        <span class="countdown" th:attr="data-end=${dc.endDateAsString}">c√≤n l·∫°i...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- S·∫£n ph·∫©m n·ªïi b·∫≠t -->
        <div class="mb-4">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-3 text-primary">S·∫£n ph·∫©m n·ªïi b·∫≠t</h2>
                </div>
            </div>
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
                <div class="col" th:each="product : ${featuredProducts}">
                    <div class="card h-100">
                        <img th:if="${product.image != null}"
                             th:src="@{/images/{img}(img=${product.image})}"
                             class="card-img-top" alt="Product Image"/>
                        <div class="card-body">
                            <h5 class="card-title" th:text="${product.name}"></h5>
                            <div th:if="${product.onSale}">
                                <p class="card-text mb-1 text-muted text-decoration-line-through"
                                   th:text="${#numbers.formatDecimal(product.originalPrice, 0, 'POINT', 3, 'COMMA') + ' ƒë'}"></p>
                                <p class="card-text text-danger fw-bold"
                                   th:text="${#numbers.formatDecimal(product.discountedPrice, 0, 'POINT', 3, 'COMMA') + ' ƒë'}"></p>
                            </div>
                            <div th:if="${!product.onSale}">
                                <p class="card-text fw-semibold"
                                   th:text="${#numbers.formatDecimal(product.originalPrice, 0, 'POINT', 3, 'COMMA') + ' ƒë'}"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pagination Featured -->
            <div class="row mt-4">
                <div class="col-12">
                    <nav aria-label="Featured pagination">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" th:each="page : ${#numbers.sequence(0, featuredTotalPages - 1)}"
                                th:classappend="${page == featuredCurrentPage} ? 'active'">
                                <a class="page-link"
                                   th:href="@{/products/list(featuredPage=${page}, newestPage=${newestCurrentPage})}"
                                   th:text="${page + 1}">1</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        <hr class="my-5"/>

        <!-- S·∫£n ph·∫©m m·ªõi nh·∫•t -->
        <div class="mb-4">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-3 text-success">S·∫£n ph·∫©m m·ªõi nh·∫•t</h2>
                </div>
            </div>
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
                <div class="col" th:each="product : ${newestProducts}">
                    <div class="card h-100">
                        <img th:if="${product.image != null}"
                             th:src="@{/images/{img}(img=${product.image})}"
                             class="card-img-top" alt="Product Image"/>
                        <div class="card-body">
                            <h5 class="card-title" th:text="${product.name}"></h5>
                            <div th:if="${product.onSale}">
                                <p class="card-text mb-1 text-muted text-decoration-line-through"
                                   th:text="${#numbers.formatDecimal(product.originalPrice, 0, 'POINT', 3, 'COMMA') + ' ƒë'}"></p>
                                <p class="card-text text-danger fw-bold"
                                   th:text="${#numbers.formatDecimal(product.discountedPrice, 0, 'POINT', 3, 'COMMA') + ' ƒë'}"></p>
                            </div>
                            <div th:if="${!product.onSale}">
                                <p class="card-text fw-semibold"
                                   th:text="${#numbers.formatDecimal(product.originalPrice, 0, 'POINT', 3, 'COMMA') + ' ƒë'}"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pagination Newest -->
            <div class="row mt-4">
                <div class="col-12">
                    <nav aria-label="Newest pagination">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" th:each="page : ${#numbers.sequence(0, newestTotalPages - 1)}"
                                th:classappend="${page == newestCurrentPage} ? 'active'">
                                <a class="page-link"
                                   th:href="@{/products/list(featuredPage=${featuredCurrentPage}, newestPage=${page})}"
                                   th:text="${page + 1}">1</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

    </div>

    <!-- JavaScript Countdown cho khuy·∫øn m√£i -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const countdowns = document.querySelectorAll(".countdown");
            countdowns.forEach(el => {
                const endTime = new Date(el.dataset.end).getTime();

                const updateCountdown = () => {
                    const now = new Date().getTime();
                    const diff = endTime - now;

                    if (diff <= 0) {
                        el.innerText = "ƒë√£ h·∫øt h·∫°n";
                        el.classList.add("text-danger");
                        return;
                    }

                    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
                    const minutes = Math.floor((diff / (1000 * 60)) % 60);
                    const seconds = Math.floor((diff / 1000) % 60);

                    el.innerText = `c√≤n l·∫°i ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                };

                updateCountdown();
                setInterval(updateCountdown, 1000);
            });
        });
    </script>

</div>
